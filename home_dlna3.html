<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnePlay IPTV</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>TV</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --bg:#0f0f1e; --card:#1a1a2e; --accent:#00d4ff; --text:#e0e0ff; --text-muted:#94a3b8; 
                --border:#2a2a4a; --success:#10b981; --error:#ef4444; --warning:#f59e0b; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#0f0f1e,#16213e); color:var(--text); min-height:100vh; padding-top:90px; }
        .header { background:rgba(0,0,0,0.8); backdrop-filter:blur(12px); padding:15px; text-align:center; position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid rgba(255,255,255,0.15); box-shadow:0 4px 20px rgba(0,0,0,0.3); }
        .header h1 { font-size:1.9rem; background:linear-gradient(90deg,#00d4ff,#7c3aed); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .header p { font-size:0.9rem; color:#94a3b8; margin-top:5px; }

        .back-btn {
            position: fixed;
            top: 12px;           
            left: 15px;
            z-index: 1001;       
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
            display: none;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .back-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0, 212, 255, 0.6); }
        .back-btn i { font-size: 1.4rem; }

        .container { max-width:1400px; margin:0 auto; padding:20px; }
        .server-selector { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-bottom:30px; padding:15px; background:rgba(0,0,0,0.3); border-radius:16px; border:1px solid rgba(255,255,255,0.1); }
        .server-btn { padding:12px 22px; background:var(--card); border:1px solid rgba(255,255,255,0.15); border-radius:12px; color:white; cursor:pointer; transition:all .3s; font-weight:600; min-width:100px; }
        .server-btn.active, .server-btn:hover { background:linear-gradient(135deg,#00d4ff,#7c3aed); transform:translateY(-3px); box-shadow:0 10px 25px rgba(0,212,255,.4); }

        .categories, .channels-grid { display:grid; gap:20px; transition:all .4s ease; }
        .categories { grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); }
        .channels-grid { grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); display:none; }

        .category, .channel-card {
            background:var(--card); border-radius:16px; overflow:hidden; cursor:pointer;
            transition:all .3s; border:1px solid rgba(255,255,255,0.1); text-align:center;
        }
        .category { padding:25px 15px; }
        .category:hover { transform:translateY(-10px); background:rgba(0,212,255,.15); box-shadow:0 15px 30px rgba(0,212,255,.2); }
        .category i { font-size:3rem; color:var(--accent); margin-bottom:12px; }
        .category small { display:block; margin-top:8px; color:#94a3b8; font-size:0.85rem; }

        .channel-card:hover { transform:scale(1.06); box-shadow:0 20px 40px rgba(0,212,255,.3); }
        .channel-logo { width:100%; height:120px; object-fit:contain; background:#111; padding:10px; }
        .channel-name { padding:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        /* PLAYER */
        .player-container { 
            position:fixed; top:0; left:0; right:0; bottom:0; 
            background:rgba(0,0,0,.98); 
            z-index:9999; 
            display:none; 
            flex-direction:column; 
        }
        .player-header { 
            padding:15px 20px; background:rgba(0,0,0,.8); display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); 
            z-index: 10000;
        }
        .close-player { background:none; border:none; color:white; font-size:2.5rem; cursor:pointer; }
        #iptv-video { 
            width:100%; 
            height:calc(100vh - 70px); 
            background:black; 
            position: relative; 
            z-index: 1; /* Fica atr√°s do painel DLNA */
        }
        .loading { 
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.6rem; color:#00d4ff; font-weight:600; display:block; z-index: 2; 
        }
        .cast-btn { background:linear-gradient(135deg,var(--accent),#4f46e5); color:#fff; padding:10px 15px; border-radius:8px; font-size:0.9rem; margin-left:10px; }

        /* PAINEL DLNA/CHROMECAST - SEMPRE POR CIMA DO PLAYER */
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid var(--accent);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            z-index: 99999 !important;     /* FOR√áA ficar acima de tudo */
            display: none;
            animation: slideUp 0.4s ease-out;
        }
        .status.active { display: block; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .status-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .status-badge { padding:4px 12px; border-radius:12px; font-size:.75rem; font-weight:600; text-transform:uppercase; }
        .status-badge.playing { background:rgba(16,185,129,.3); color:var(--success); }
        .status-badge.paused { background:rgba(245,158,11,.3); color:var(--warning); }
        .status-badge.stopped { background:rgba(148,163,184,.3); color:var(--text-muted); }
        .status-row { display:flex; justify-content:space-between; padding:6px 0; font-size:.9rem; }
        .status-row span:first-child { color:var(--text-muted); }
        .status-controls { display:flex; gap:10px; margin-top:15px; }
        .status-controls .btn { 
            flex:1; padding:12px; font-size:1rem; border:none; border-radius:10px; cursor:pointer; font-weight:600; 
        }
        .btn-success { background:var(--success); }
        .btn-warning { background:var(--warning); color:#000; }
        .btn-danger { background:var(--error); }

        /* DLNA/CHROMECAST Modal */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(8px);justify-content:center;align-items:center;z-index:20000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:450px;max-height:80vh;overflow:hidden}
        .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer}
        .modal-body{padding:20px;max-height:400px;overflow-y:auto}
        .device-list{list-style:none}
        .device-item{padding:15px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s}
        .device-item:hover{border-color:var(--accent);transform:translateX(4px)}
        .device-item.selected{border-color:var(--success);background:rgba(16,185,129,.1)}
        .device-icon{font-size:1.8rem; width: 40px; text-align: center;}
        .device-name{font-weight:600}
        .device-details{font-size:.8rem;color:var(--text-muted);margin-top:2px}
        .device-badge{display:inline-block;padding:2px 8px;background:rgba(99,102,241,.2);border-radius:6px;font-size:.65rem;color:var(--accent);margin-left:8px}
        .loading{text-align:center;padding:40px;color:var(--text-muted)}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .tips{margin-top:15px;padding:12px;background:rgba(245,158,11,.1);border-radius:8px;font-size:.8rem}
        .tips h4{color:var(--warning);margin-bottom:8px}
        .tips ul{margin-left:16px}
        .toast-container{position:fixed;top:20px;right:20px;z-index:30000}
        .toast{padding:14px 20px;border-radius:10px;margin-bottom:8px;display:flex;align-items:center;gap:10px;animation:slideIn .4s;color:#fff;font-weight:500}
        .toast.success{background:var(--success);}
        .toast.error{background:var(--error);}
        .toast.info{background:var(--accent);}
        @keyframes slideIn{from{opacity:0;transform:translateX(50px)}}

        @media (max-width:768px) {
            body { padding-top:100px; }
            .categories { grid-template-columns:repeat(3,1fr); }
            .channels-grid { grid-template-columns:repeat(2,1fr); }
            .back-btn { top:75px; padding:10px 16px; font-size:0.9rem; }
            .status { bottom: 15px; left: 15px; right: 15px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>OnePlay IPTV</h1>
        <p>Selecione uma lista para come√ßar</p>
    </div>

    <button class="back-btn" onclick="showCategories()">
        <i class="fas fa-arrow-left"></i> Voltar
    </button>

    <div class="container">
        <div class="server-selector" id="serverSelector"></div>
        <div id="categories" class="categories"></div>
        <div id="channels" class="channels-grid"></div>
    </div>

    <!-- PLAYER COM PAINEL DLNA SEMPRE VIS√çVEL -->
    <div id="playerContainer" class="player-container">
        <div class="player-header">
            <span id="playingChannel">Carregando...</span>
            <button class="cast-btn" onclick="openCastModal()">üì∫ Espelhar para TV</button>
            <button class="close-player" onclick="closePlayer()">√ó</button>
        </div>
        <video id="iptv-video" controls playsinline></video>
        <div class="loading" id="loading">Carregando stream...</div>

        <!-- PAINEL DLNA/CHROMECAST FLUTUANTE (sempre por cima!) -->
        <div class="status" id="status">
            <div class="status-header">
                <strong>Transmitindo para TV</strong>
                <span class="status-badge playing" id="status-badge">ATIVO</span>
            </div>
            <div class="status-row"><span>Dispositivo:</span><span id="s-device">-</span></div>
            <div class="status-row"><span>Tipo:</span><span id="s-type">-</span></div>
            <div class="status-controls">
                <button class="btn btn-success" onclick="control('play')">‚ñ∂Ô∏è Play</button>
                <button class="btn btn-warning" onclick="control('pause')">‚è∏Ô∏è Pause</button>
                <button class="btn btn-danger" onclick="control('stop')">‚èπÔ∏è Stop</button>
            </div>
        </div>
    </div>

    <!-- MODAL DLNA/CHROMECAST -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üì∫ Selecione um Dispositivo</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="devices">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Clique em "Buscar Dispositivos" para come√ßar</p>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid var(--border); text-align: center;">
                <button style="padding: 10px 20px; background: linear-gradient(135deg, #00d4ff, #7c3aed); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;" onclick="search()">
                    üîç Buscar Dispositivos
                </button>
                <div class="tips">
                    <h4>üì° Dicas de Conex√£o:</h4>
                    <ul>
                        <li>TV e celular na mesma rede Wi-Fi</li>
                        <li>Ative DLNA/UPnP na TV (para TVs Samsung, LG, Sony)</li>
                        <li>Para Chromecast/Android TV, ative "Espelhamento de tela"</li>
                        <li>Tente desativar firewall temporariamente se n√£o encontrar</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toasts"></div>

    <script>
        const video = document.getElementById("iptv-video");
        const playerContainer = document.getElementById("playerContainer");
        const loading = document.getElementById("loading");
        const playingChannelEl = document.getElementById("playingChannel");
        const backBtn = document.querySelector(".back-btn");
        let hls = null;
        let isPlayerOpen = false;
        let currentChannelUrl = '';
        let currentChannelName = '';

        // Estado DLNA/Chromecast
        let devices = [];
        let selectedDevice = null;
        let controlUrl = null;
        let streamId = null;
        let active = false;

        function destroyPlayer() {
            if (hls) { hls.destroy(); hls = null; }
            video.pause(); video.removeAttribute("src"); video.load();
            loading.style.display = "block";
        }

        function closePlayer() {
            isPlayerOpen = false;
            playerContainer.style.display = "none";
            destroyPlayer();
            playingChannelEl.textContent = "Carregando...";
            document.getElementById('status').classList.remove('active');
            stopAll(); // Para transmiss√£o DLNA/Chromecast ao fechar
        }

        function playChannel(url, name) {
            if (isPlayerOpen) destroyPlayer();
            isPlayerOpen = true;
            playerContainer.style.display = "flex";
            playingChannelEl.textContent = name;
            currentChannelUrl = url;
            currentChannelName = name;

            if (Hls.isSupported()) {
                hls = new Hls({ lowLatencyMode: true, backBufferLength: 90 });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => { 
                    loading.style.display = "none";
                    video.play().catch(e => console.log("Autoplay blocked:", e));
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.log("HLS Error:", data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                toast('Erro de rede - tentando reconectar...', 'error');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                toast('Erro de m√≠dia - recarregando...', 'error');
                                hls.recoverMediaError();
                                break;
                            default:
                                toast('Erro no player - recarregando...', 'error');
                                destroyPlayer();
                                setTimeout(() => playChannel(url, name), 1000);
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', () => { 
                    loading.style.display = "none";
                    video.play().catch(e => console.log("Autoplay blocked:", e));
                });
            } else {
                loading.textContent = "Navegador n√£o suporta HLS";
            }
        }

        function showCategories() {
            document.getElementById("categories").style.display = "grid";
            document.getElementById("channels").style.display = "none";
            backBtn.style.display = "none";
            document.querySelector(".header p").textContent = "Selecione uma categoria";
        }

        function showChannels(group) {
            const filtered = window.allChannels.filter(c => c.group === group);
            document.getElementById("channels").innerHTML = filtered.map(c => `
                <div class="channel-card" onclick="playChannel('${c.url.replace(/'/g, "\\'")}', '${c.name.replace(/'/g, "\\'")}')">
                    <img src="${c.logo || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>TV</text></svg>'}"
                         class="channel-logo" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>TV</text></svg>'">
                    <div class="channel-name">${c.name}</div>
                </div>
            `).join("");
            document.getElementById("categories").style.display = "none";
            document.getElementById("channels").style.display = "grid";
            backBtn.style.display = "flex";
            document.querySelector(".header p").textContent = group;
        }

        function loadList(id) {
            document.getElementById("categories").innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#00d4ff;font-size:1.6rem;"><i class="fas fa-spinner fa-spin"></i><br>Carregando lista...</div>';

            fetch(`/oneplay?lista=lista${id}`)
                .then(r => r.ok ? r.text() : Promise.reject("Lista n√£o encontrada"))
                .then(text => {
                    const lines = text.split("\n");
                    const channels = [];
                    let current = null;
                    for (let line of lines) {
                        line = line.trim();
                        if (line.startsWith("#EXTINF:")) {
                            const name = (line.match(/,(.*)$/)?.[1] || "Canal").trim();
                            const logo = line.match(/tvg-logo="([^"]+)"/i)?.[1] || "";
                            const group = line.match(/group-title="([^"]+)"/i)?.[1]?.trim() || "Outros";
                            current = { name, logo, group, url: "" };
                        } else if (line.startsWith("http") && current) {
                            current.url = line;
                            channels.push(current);
                            current = null;
                        }
                    }
                    window.allChannels = channels;
                    const groups = [...new Set(channels.map(c => c.group))].sort();

                    document.getElementById("categories").innerHTML = groups.length ? groups.map(g => `
                        <div class="category" onclick="showChannels('${g.replace(/'/g, "\\'")}')">
                            <i class="fas fa-tv"></i>
                            <div>${g}</div>
                            <small>${channels.filter(c => c.group === g).length} canais</small>
                        </div>
                    `).join("") : '<div style="grid-column:1/-1;text-align:center;padding:50px;color:#94a3b8;">Nenhum canal encontrado</div>';

                    showCategories();
                })
                .catch(err => {
                    document.getElementById("categories").innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:60px;color:#ff6b6b;">Erro ao carregar lista<br><small>${err}</small></div>`;
                });
        }

        // Inicializar bot√µes das listas
        for (let i = 1; i <= 10; i++) {
            const num = i.toString().padStart(2, "0");
            const btn = document.createElement("div");
            btn.className = "server-btn" + (i===1 ? " active" : "");
            btn.textContent = "Lista " + num;
            btn.onclick = () => {
                document.querySelectorAll(".server-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                loadList(num);
            };
            document.getElementById("serverSelector").appendChild(btn);
        }

        // Carregar lista inicial
        loadList("01");

        // Fun√ß√µes DLNA/Chromecast
        function toast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${msg}</span>`;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        function openCastModal() {
            const url = currentChannelUrl;
            if (!url) {
                toast('Selecione um canal primeiro!', 'error');
                return;
            }
            document.getElementById('modal').classList.add('active');
            search();
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        async function search() {
            document.getElementById('devices').innerHTML = '<div class="loading"><div class="spinner"></div><p>Buscando dispositivos na rede...</p></div>';
            
            try {
                const response = await fetch('/api/discover');
                const data = await response.json();
                
                if (data.success && data.devices.length > 0) {
                    devices = data.devices;
                    renderDevices();
                } else {
                    document.getElementById('devices').innerHTML = `
                        <div class="loading">
                            <p>Nenhum dispositivo encontrado</p>
                            <div class="tips">
                                <h4>üîç Como encontrar dispositivos:</h4>
                                <ul>
                                    <li>Verifique se a TV est√° ligada e na mesma rede Wi-Fi</li>
                                    <li>Para TVs DLNA (Samsung, LG, Sony): Ative DLNA/UPnP nas configura√ß√µes</li>
                                    <li>Para Chromecast/Android TV: Ative "Espelhamento de tela"</li>
                                    <li>Reinicie o proxy e tente novamente</li>
                                </ul>
                            </div>
                            <button style="margin-top:15px;padding:10px 20px;background:var(--accent);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600" onclick="search()">
                                üîÑ Buscar Novamente
                            </button>
                        </div>`;
                }
            } catch (e) {
                document.getElementById('devices').innerHTML = `<div class="loading"><p style="color:var(--error)">Erro na busca: ${e.message}</p></div>`;
                toast('Erro ao buscar dispositivos', 'error');
            }
        }

        function renderDevices() {
            let html = '<ul class="device-list">';
            devices.forEach((d, i) => {
                const isSelected = selectedDevice && selectedDevice.id === d.id;
                const deviceType = d.type || 'dlna'; // Padr√£o para DLNA se n√£o especificado
                const deviceIcon = getDeviceIcon(d);
                const deviceLabel = getDeviceTypeLabel(d);
                
                html += `
                    <li class="device-item ${isSelected ? 'selected' : ''}" onclick="selectDevice(${i})">
                        <span class="device-icon">${deviceIcon}</span>
                        <div>
                            <div class="device-name">${escapeHtml(d.name)} 
                                <span class="device-badge">${deviceLabel}</span>
                            </div>
                            <div class="device-details">
                                ${d.manufacturer || ''} ${d.model || ''}<br>
                                <small>IP: ${d.ip} ‚Ä¢ ${deviceType === 'chromecast' ? 'Chromecast' : 'DLNA'}</small>
                            </div>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            document.getElementById('devices').innerHTML = html;
        }

        function getDeviceIcon(device) {
            const type = device.type || device.tv_type || 'dlna';
            if (type.includes('chromecast') || type === 'chromecast') return 'üî¥';
            if (type.includes('lg')) return 'üü£';
            if (type.includes('samsung')) return 'üîµ';
            if (type.includes('android')) return 'üü¢';
            if (type.includes('roku')) return 'üü†';
            return 'üì∫';
        }

        function getDeviceTypeLabel(device) {
            const type = device.type || device.tv_type || 'dlna';
            if (type.includes('chromecast') || type === 'chromecast') return 'Chromecast';
            if (type.includes('lg')) return 'LG WebOS';
            if (type.includes('samsung')) return 'Samsung';
            if (type.includes('android')) return 'Android TV';
            if (type.includes('roku')) return 'Roku';
            return 'DLNA';
        }

        async function selectDevice(i) {
            const device = devices[i];
            const url = currentChannelUrl;
            
            toast(`Conectando √† ${device.name}...`, 'info');
            
            try {
                const response = await fetch('/api/cast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        device_info: device,
                        title: currentChannelName || 'Stream OnePlay'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    selectedDevice = device;
                    controlUrl = device.control_url;
                    streamId = data.stream_id;
                    active = true;
                    
                    closeModal();
                    updateUI();
                    toast(`‚úÖ Transmitindo para ${device.name}!`, 'success');
                    renderDevices();
                } else {
                    toast(`‚ùå Erro: ${data.error}`, 'error');
                }
            } catch (e) {
                toast('‚ùå Falha na conex√£o', 'error');
                console.error('Cast error:', e);
            }
        }

        async function stopAll() {
            if (controlUrl && selectedDevice && (selectedDevice.type === 'dlna' || !selectedDevice.type)) {
                try {
                    await fetch('/api/control', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'stop',
                            control_url: controlUrl
                        })
                    });
                } catch (e) {
                    console.error('Stop error:', e);
                }
            }
            
            if (streamId) {
                try {
                    await fetch('/api/stop-stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stream_id: streamId })
                    });
                } catch (e) {
                    console.error('Stop stream error:', e);
                }
            }
            
            reset();
            toast('Transmiss√£o parada', 'info');
        }

        async function control(action) {
            if (!controlUrl || !selectedDevice || selectedDevice.type === 'chromecast') {
                // Para Chromecast, apenas mostra mensagem
                if (selectedDevice && selectedDevice.type === 'chromecast') {
                    toast('Controle manual n√£o dispon√≠vel para Chromecast', 'info');
                }
                return;
            }
            
            try {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        control_url: controlUrl
                    })
                });
                
                const badge = document.getElementById('status-badge');
                if (action === 'stop') {
                    badge.textContent = 'PARADO';
                    badge.className = 'status-badge stopped';
                    stopAll();
                } else if (action === 'pause') {
                    badge.textContent = 'PAUSADO';
                    badge.className = 'status-badge paused';
                } else {
                    badge.textContent = 'ATIVO';
                    badge.className = 'status-badge playing';
                }
            } catch (e) {
                toast('Erro no controle', 'error');
            }
        }

        function updateUI() {
            const statusPanel = document.getElementById('status');
            statusPanel.classList.toggle('active', active);
            
            if (active && selectedDevice) {
                document.getElementById('s-device').textContent = selectedDevice.name;
                document.getElementById('s-type').textContent = getDeviceTypeLabel(selectedDevice);
            }
        }

        function reset() {
            selectedDevice = null;
            controlUrl = null;
            streamId = null;
            active = false;
            updateUI();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        window.addEventListener("popstate", () => { if (isPlayerOpen) closePlayer(); });
        document.addEventListener("keydown", e => { if (e.key === "Escape" && isPlayerOpen) closePlayer(); });
        playerContainer.addEventListener("click", e => { if (e.target === playerContainer) closePlayer(); });
        document.getElementById('modal').onclick = e => { if (e.target.id === 'modal') closeModal(); };

        // Adicionar input hidden para compatibilidade
        document.body.innerHTML += '<input type="hidden" id="url-input">';
    </script>
</body>
</html>
