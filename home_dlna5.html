<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnePlay IPTV</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>TV</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --bg:#0f0f1e; --card:#1a1a2e; --accent:#00d4ff; --text:#e0e0ff; --text-muted:#94a3b8;
                --border:#2a2a4a; --success:#10b981; --error:#ef4444; --warning:#f59e0b; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#0f0f1e,#16213e); color:var(--text); min-height:100vh; padding-top:90px; }
        .header { background:rgba(0,0,0,0.8); backdrop-filter:blur(12px); padding:15px; text-align:center; position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid rgba(255,255,255,0.15); box-shadow:0 4px 20px rgba(0,0,0,0.3); }
        .header h1 { font-size:1.9rem; background:linear-gradient(90deg,#00d4ff,#7c3aed); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .header p { font-size:0.9rem; color:#94a3b8; margin-top:5px; }

        .back-btn {
            position: fixed; top: 12px; left: 15px; z-index: 1001;
            background: linear-gradient(135deg, #00d4ff, #7c3aed); color: white; border: none; border-radius: 50px;
            padding: 12px 20px; font-size: 1rem; font-weight: 600; cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5); display: none; align-items: center; gap: 10px; transition: all 0.3s ease;
        }
        .back-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0, 212, 255, 0.6); }
        .back-btn i { font-size: 1.4rem; }

        .container { max-width:1400px; margin:0 auto; padding:20px; }
        .server-selector { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-bottom:30px; padding:15px; background:rgba(0,0,0,0.3); border-radius:16px; border:1px solid rgba(255,255,255,0.1); }
        .server-btn { padding:12px 22px; background:var(--card); border:1px solid rgba(255,255,255,0.15); border-radius:12px; color:white; cursor:pointer; transition:all .3s; font-weight:600; min-width:100px; }
        .server-btn.active, .server-btn:hover { background:linear-gradient(135deg,#00d4ff,#7c3aed); transform:translateY(-3px); box-shadow:0 10px 25px rgba(0,212,255,.4); }

        .categories, .channels-grid { display:grid; gap:20px; transition:all .4s ease; }
        .categories { grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); }
        .channels-grid { grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); display:none; }

        .category, .channel-card {
            background:var(--card); border-radius:16px; overflow:hidden; cursor:pointer;
            transition:all .3s; border:1px solid rgba(255,255,255,0.1); text-align:center;
        }
        .category { padding:25px 15px; }
        .category:hover { transform:translateY(-10px); background:rgba(0,212,255,.15); box-shadow:0 15px 30px rgba(0,212,255,.2); }
        .category i { font-size:3rem; color:var(--accent); margin-bottom:12px; }
        .category small { display:block; margin-top:8px; color:#94a3b8; font-size:0.85rem; }

        .channel-card:hover { transform:scale(1.06); box-shadow:0 20px 40px rgba(0,212,255,.3); }
        .channel-logo { width:100%; height:120px; object-fit:contain; background:#111; padding:10px; }
        .channel-name { padding:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        .player-container {
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,.98); z-index:9999; display:none; flex-direction:column;
        }
        .player-header {
            padding:15px 20px; background:rgba(0,0,0,.8); display:flex; justify-content:space-between; align-items:center;
            border-bottom:1px solid rgba(255,255,255,0.1); z-index: 10000;
        }
        .close-player { background:none; border:none; color:white; font-size:2.5rem; cursor:pointer; }
        #iptv-video { width:100%; height:calc(100vh - 70px); background:black; position: relative; z-index: 1; }
        .player-container .loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.6rem; color:#00d4ff; font-weight:600; display:block; z-index: 2; }
        .cast-btn { background:linear-gradient(135deg,var(--accent),#4f46e5); color:#fff; padding:10px 15px; border-radius:8px; font-size:0.9rem; margin-left:10px; border:none; cursor:pointer; display:flex; align-items:center; gap:8px; }

        .status {
            position: absolute; bottom: 20px; left: 20px; right: 20px; max-width: 500px; margin: 0 auto;
            padding: 20px; background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(12px);
            border: 1px solid var(--accent); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            z-index: 99999; display: none; animation: slideUp 0.4s ease-out;
        }
        .status.active { display: block; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .status-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .status-badge { padding:4px 12px; border-radius:12px; font-size:.75rem; font-weight:600; text-transform:uppercase; }
        .status-badge.playing { background:rgba(16,185,129,.3); color:var(--success); }
        .status-badge.paused { background:rgba(245,158,11,.3); color:var(--warning); }
        .status-badge.stopped { background:rgba(148,163,184,.3); color:var(--text-muted); }
        .status-row { display:flex; justify-content:space-between; padding:6px 0; font-size:.9rem; }
        .status-row span:first-child { color:var(--text-muted); }
        .status-controls { display:flex; gap:10px; margin-top:15px; }
        .status-controls .btn { flex:1; padding:12px; font-size:1rem; border:none; border-radius:10px; cursor:pointer; font-weight:600; color:white; display:flex; align-items:center; justify-content:center; gap:8px; }
        .btn-success { background:var(--success); }
        .btn-warning { background:var(--warning); color:#000; }
        .btn-danger { background:var(--error); }

        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(8px);justify-content:center;align-items:center;z-index:20000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:450px;max-height:80vh;overflow:hidden; display: flex; flex-direction: column;}
        .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer}
        .modal-body{padding:20px;max-height:400px;overflow-y:auto; flex-grow: 1;}
        .device-list{list-style:none}
        .device-item{padding:15px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s}
        .device-item:hover{border-color:var(--accent);transform:translateX(4px)}
        .device-item.selected{border-color:var(--success);background:rgba(16,185,129,.1)}
        .device-icon{font-size:1.8rem; width: 30px; text-align: center;}
        .device-name{font-weight:600}
        .device-details{font-size:.8rem;color:var(--text-muted);margin-top:2px}
        .device-badge{display:inline-block;padding:2px 8px;background:rgba(99,102,241,.2);border-radius:6px;font-size:.65rem;color:var(--accent);margin-left:8px}
        .loading-modal{text-align:center;padding:40px;color:var(--text-muted)}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .tips{margin-top:15px;padding:12px;background:rgba(245,158,11,.1);border-radius:8px;font-size:.8rem; text-align: left;}
        .tips h4{color:var(--warning);margin-bottom:8px}
        .tips ul{margin-left:16px}
        .toast-container{position:fixed;top:20px;right:20px;z-index:30000}
        .toast{padding:14px 20px;border-radius:10px;margin-bottom:8px;display:flex;align-items:center;gap:10px;animation:slideIn .4s;color:#fff;font-weight:500; background: #333;}
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        @keyframes slideIn{from{opacity:0;transform:translateX(50px)}}

        @media (max-width:768px) {
            body { padding-top:100px; }
            .categories { grid-template-columns:repeat(2,1fr); gap: 10px;}
            .channels-grid { grid-template-columns:repeat(2,1fr); gap: 10px;}
            .back-btn { top:70px; padding:8px 14px; font-size:0.8rem; }
            .status { bottom: 15px; left: 15px; right: 15px; }
        }
    </style>
</head>
<body>
    <div class="header"><h1>OnePlay IPTV</h1><p>Selecione uma lista para começar</p></div>
    <button class="back-btn" onclick="showCategories()"><i class="fas fa-arrow-left"></i> Voltar</button>

    <div class="container">
        <div class="server-selector" id="serverSelector"></div>
        <div id="categories" class="categories"></div>
        <div id="channels" class="channels-grid"></div>
    </div>

    <div id="playerContainer" class="player-container">
        <div class="player-header">
            <span id="playingChannel">Carregando...</span>
            <div>
                <button class="cast-btn" onclick="openCastModal()"><i class="fas fa-cast"></i> Espelhar</button>
                <button class="close-player" onclick="closePlayer()">×</button>
            </div>
        </div>
        <video id="iptv-video" controls playsinline></video>
        <div class="player-container-loading loading" id="loading">Carregando stream...</div>

        <div class="status" id="statusPanel">
            <div class="status-header">
                <strong>Transmitindo para TV</strong>
                <span class="status-badge playing" id="status-badge">ATIVO</span>
            </div>
            <div class="status-row"><span>Dispositivo:</span><span id="s-device">-</span></div>
            <div class="status-row"><span>Tipo:</span><span id="s-type">-</span></div>
            <div class="status-controls">
                <button class="btn btn-success" onclick="control('play')"><i class="fas fa-play"></i> Play</button>
                <button class="btn btn-warning" onclick="control('pause')"><i class="fas fa-pause"></i> Pause</button>
                <button class="btn btn-danger" onclick="control('stop')"><i class="fas fa-stop"></i> Stop</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header"><h3>Selecione um Dispositivo</h3><button class="modal-close" onclick="closeModal()">×</button></div>
            <div class="modal-body" id="devices"></div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>
    <input type="hidden" id="url-input">

    <script>
        const video = document.getElementById("iptv-video");
        const playerContainer = document.getElementById("playerContainer");
        const loading = document.getElementById("loading");
        const playingChannelEl = document.getElementById("playingChannel");
        const backBtn = document.querySelector(".back-btn");
        let hls = null;
        let isPlayerOpen = false;
        let currentChannelUrl = '';
        let currentChannelName = '';

        // --- Lógica do Player de Vídeo ---
        function destroyPlayer() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            video.pause();
            video.removeAttribute("src");
            video.load();
            loading.style.display = "block";
        }

        function closePlayer() {
            if (window.castingDevice) {
                control('stop'); // Para a transmissão ativa ao fechar o player
            }
            isPlayerOpen = false;
            playerContainer.style.display = "none";
            destroyPlayer();
            playingChannelEl.textContent = "Carregando...";
        }

        function playChannel(url, name) {
            if (isPlayerOpen) {
                destroyPlayer();
            }
            // Se houver um dispositivo transmitindo, pergunta se quer trocar o canal na TV
            if (window.castingDevice) {
                if (confirm(`Deseja exibir "${name}" na TV (${window.castingDevice.name})?`)) {
                    selectDevice(undefined, url); // Reutiliza a função de seleção com a nova URL
                }
            }

            isPlayerOpen = true;
            playerContainer.style.display = "flex";
            playingChannelEl.textContent = name;
            currentChannelUrl = url;
            currentChannelName = name;

            if (Hls.isSupported()) {
                hls = new Hls({ lowLatencyMode: true, backBufferLength: 90 });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                    loading.style.display = "none";
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('Erro fatal no HLS:', data);
                    }
                });
            } else {
                video.src = url;
                video.addEventListener('canplay', () => {
                    video.play();
                    loading.style.display = "none";
                });
            }
        }


        // --- Lógica de Navegação da UI (Listas, Categorias, Canais) ---
        function showCategories() {
            document.getElementById("categories").style.display = "grid";
            document.getElementById("channels").style.display = "none";
            backBtn.style.display = "none";
            document.querySelector(".header p").textContent = "Selecione uma categoria";
        }

        function showChannels(group) {
            const filtered = window.allChannels.filter(c => c.group === group);
            const channelsEl = document.getElementById("channels");
            channelsEl.innerHTML = filtered.map(c => {
                const safeUrl = c.url.replace(/'/g, "\\'");
                const safeName = c.name.replace(/'/g, "\\'");
                return `
                <div class="channel-card" onclick="playChannel('${safeUrl}', '${safeName}')">
                    <img src="${c.logo || ' '}" class="channel-logo" onerror="this.style.display='none';">
                    <div class="channel-name">${c.name}</div>
                </div>`;
            }).join("");

            document.getElementById("categories").style.display = "none";
            channelsEl.style.display = "grid";
            backBtn.style.display = "flex";
            document.querySelector(".header p").textContent = group;
        }

        function loadList(id) {
            const categoriesEl = document.getElementById("categories");
            categoriesEl.innerHTML = `<div class="loading-modal" style="grid-column:1/-1;"><div class="spinner"></div>Carregando lista...</div>`;
            fetch(`/oneplay?lista=lista${id}`)
                .then(r => r.ok ? r.text() : Promise.reject(new Error(`HTTP error! status: ${r.status}`)))
                .then(text => {
                    const channels = [];
                    let currentInfo = null;
                    for (const line of text.split('\\n')) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith("#EXTINF:")) {
                            currentInfo = {
                                name: (trimmedLine.match(/,(.*)$/)?.[1] || "Canal").trim(),
                                logo: trimmedLine.match(/tvg-logo="([^"]+)"/i)?.[1] || "",
                                group: trimmedLine.match(/group-title="([^"]+)"/i)?.[1]?.trim() || "Outros",
                                url: ""
                            };
                        } else if (trimmedLine.startsWith("http") && currentInfo) {
                            currentInfo.url = trimmedLine;
                            channels.push(currentInfo);
                            currentInfo = null;
                        }
                    }
                    window.allChannels = channels;
                    const groups = [...new Set(channels.map(c => c.group))].sort();
                    categoriesEl.innerHTML = groups.length ? groups.map(g => {
                        const safeGroup = g.replace(/'/g, "\\'");
                        return `
                        <div class="category" onclick="showChannels('${safeGroup}')">
                            <i class="fas fa-folder"></i>
                            <div>${g}</div>
                            <small>${channels.filter(c => c.group === g).length} canais</small>
                        </div>`;
                    }).join("") : `<div class="loading-modal" style="grid-column:1/-1;">Nenhum canal encontrado.</div>`;
                    showCategories();
                })
                .catch(err => {
                     categoriesEl.innerHTML = `<div class="loading-modal" style="grid-column:1/-1; color:var(--error);">Erro ao carregar a lista.<br><small>${err.message}</small></div>`;
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const serverSelector = document.getElementById("serverSelector");
            for (let i = 1; i <= 10; i++) {
                const num = i.toString().padStart(2, "0");
                const btn = document.createElement("button");
                btn.className = "server-btn" + (i === 1 ? " active" : "");
                btn.textContent = "Lista " + num;
                btn.onclick = () => {
                    serverSelector.querySelectorAll(".server-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    loadList(num);
                };
                serverSelector.appendChild(btn);
            }
            loadList("01");
        });


        // --- Lógica de Transmissão (DLNA & Chromecast) ---
        let discoveredDevices = [];
        window.castingDevice = null;

        function toast(message, type = 'success') {
            const container = document.getElementById('toasts');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function openCastModal() {
            if (!currentChannelUrl) {
                toast('Por favor, abra um canal primeiro.', 'error');
                return;
            }
            document.getElementById('modal').classList.add('active');
            searchDevices();
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        async function searchDevices() {
            const devicesEl = document.getElementById('devices');
            devicesEl.innerHTML = `<div class="loading-modal"><div class="spinner"></div><p>Buscando dispositivos na rede...</p></div>`;
            try {
                const response = await fetch('/api/discover');
                const data = await response.json();
                if (data.success && data.devices.length > 0) {
                    discoveredDevices = data.devices;
                    renderDevices();
                } else {
                    devicesEl.innerHTML = `<div class="loading-modal">
                        <p>Nenhum dispositivo encontrado.</p>
                        <div class="tips"><h4>Dicas:</h4><ul><li>Sua TV e celular devem estar na mesma rede Wi-Fi.</li><li>Verifique se a opção "Transmitir" ou "DLNA" está ativa na TV.</li></ul></div>
                        <button class="server-btn" style="margin-top:15px" onclick="searchDevices()">Buscar Novamente</button>
                    </div>`;
                }
            } catch (e) {
                toast('Erro ao buscar dispositivos.', 'error');
                devicesEl.innerHTML = `<div class="loading-modal"><p>Ocorreu um erro na busca.</p></div>`;
            }
        }

        function renderDevices() {
            const devicesEl = document.getElementById('devices');
            let html = '<ul class="device-list">';
            discoveredDevices.forEach((device, index) => {
                const isSelected = window.castingDevice && window.castingDevice.ip === device.ip;
                const iconClass = getDeviceIcon(device.tv_type);
                const deviceLabel = getDeviceLabel(device.tv_type);
                html += `
                <li class="device-item ${isSelected ? 'selected' : ''}" onclick="selectDevice(${index})">
                    <i class="fas ${iconClass} device-icon"></i>
                    <div>
                        <div class="device-name">${escapeHTML(device.name)}<span class="device-badge">${deviceLabel}</span></div>
                        <div class="device-details">${escapeHTML(device.manufacturer || device.ip)}</div>
                    </div>
                </li>`;
            });
            html += '</ul><button class="server-btn" style="margin-top:15px; width: 100%;" onclick="searchDevices()">Atualizar Lista</button>';
            devicesEl.innerHTML = html;
        }

        function getDeviceIcon(type) {
            if (!type) return 'fa-tv'; // Ícone padrão
            if (type.includes('chromecast')) return 'fa-google'; // Ícone do Google para Chromecast/Android
            if (type.includes('roku')) return 'fa-registered';
            return 'fa-tv'; // Ícone padrão para DLNA/outros
        }

        function getDeviceLabel(type) {
            if (!type) return 'DLNA';
            if (type.includes('chromecast')) return 'Chromecast';
            if (type.includes('android')) return 'Android TV';
            if (type.includes('lg')) return 'LG WebOS';
            if (type.includes('samsung')) return 'Samsung';
            if (type.includes('roku')) return 'Roku';
            return 'DLNA';
        }

        // A url é opcional, usada para trocar de canal em um dispositivo já conectado
        async function selectDevice(index, url = null) {
            // Se o índice não for fornecido, significa que estamos re-transmitindo para o mesmo dispositivo
            const device = index !== undefined ? discoveredDevices[index] : window.castingDevice;
            if (!device) return;

            const streamUrl = url || currentChannelUrl;
            if (!streamUrl) {
                toast('Nenhuma URL de canal para transmitir.', 'error');
                return;
            }

            toast(`Conectando a ${device.name}...`);

            try {
                const response = await fetch('/api/cast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: streamUrl,
                        device_name: device.name,
                        tv_type: device.tv_type,
                        ip: device.ip,
                        port: device.port,
                        control_url: device.control_url
                    })
                });
                const data = await response.json();
                if (data.success) {
                    window.castingDevice = device; // Atualiza o dispositivo de transmissão global
                    closeModal();
                    updateCastStatusUI();
                    toast(`Transmitindo para ${device.name}!`, 'success');
                    renderDevices(); // Re-renderiza a lista para mostrar o item selecionado
                } else {
                    throw new Error(data.error || 'Erro desconhecido ao tentar transmitir.');
                }
            } catch (e) {
                toast(`Falha ao transmitir: ${e.message}`, 'error');
                // Não limpa o castingDevice aqui, para permitir novas tentativas
            }
        }

        async function control(action) {
            if (!window.castingDevice) return;

            const device = window.castingDevice;
            const badge = document.getElementById('status-badge');

            try {
                 const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        tv_type: device.tv_type,
                        ip: device.ip,
                        control_url: device.control_url
                    })
                });

                if (!response.ok) {
                    throw new Error('O dispositivo não respondeu ao comando.');
                }

                if (action === 'stop') {
                    toast('Transmissão parada.');
                    window.castingDevice = null; // Limpa o dispositivo
                    updateCastStatusUI();
                    renderDevices(); // Atualiza a lista para remover a seleção
                } else if (action === 'pause') {
                    badge.textContent = 'PAUSADO';
                    badge.className = 'status-badge paused';
                } else if (action === 'play') {
                    badge.textContent = 'ATIVO';
                    badge.className = 'status-badge playing';
                }
            } catch (e) {
                toast(`Erro no controle: ${e.message}`, 'error');
            }
        }

        function updateCastStatusUI() {
            const panel = document.getElementById('statusPanel');
            if (window.castingDevice) {
                document.getElementById('s-device').textContent = window.castingDevice.name;
                document.getElementById('s-type').textContent = getDeviceLabel(window.castingDevice.tv_type);
                panel.classList.add('active');
                // Garante que o status inicial seja 'ATIVO'
                const badge = document.getElementById('status-badge');
                badge.textContent = 'ATIVO';
                badge.className = 'status-badge playing';
            } else {
                panel.classList.remove('active');
            }
        }

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Adiciona evento para fechar o modal ao clicar fora dele
        document.getElementById('modal').addEventListener('click', e => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

    </script>
</body>
</html>
